<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Cajero - Supabase</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <!-- Pantalla de Login -->
    <div id="loginScreen" class="screen active">
        <div class="login-container">
            <h1>Sistema de Cajero</h1>
            <form id="loginForm">
                <input type="text" id="username" placeholder="Usuario" required>
                <input type="password" id="password" placeholder="Contraseña" required>
                <button type="submit">Iniciar Sesión</button>
            </form>
            <p class="hint">Usuario por defecto: admin | Contraseña: admin</p>
            <div id="loginError" class="error-message"></div>
        </div>
    </div>

    <!-- Pantalla Principal -->
    <div id="mainScreen" class="screen">
        <nav class="navbar">
            <h1>Sistema de Cajero</h1>
            <div class="nav-info">
                <span id="userInfo"></span>
            </div>
            <div class="nav-buttons">
                <button onclick="showSection('ventas')">Ventas</button>
                <button onclick="showSection('productos')">Productos</button>
                <button onclick="showSection('reportes')">Reportes</button>
                <button onclick="logout()">Cerrar Sesión</button>
            </div>
        </nav>

        <!-- Sección de Ventas -->
        <div id="ventasSection" class="section active">
            <div class="sales-container">
                <div class="scanner-area">
                    <h2>Escanear Producto</h2>
                    <div id="cameraSelector" style="display:none; margin-bottom: 10px;">
                        <label>Seleccionar cámara:</label>
                        <select id="cameraSelect" onchange="changeScannerCamera()"></select>
                    </div>
                    <video id="video" autoplay playsinline></video>
                    <button id="startScanner" onclick="startScanner()">Iniciar Escáner</button>
                    <button id="stopScanner" onclick="stopScanner()" style="display:none;">Detener Escáner</button>
                    <p>O ingrese código manualmente:</p>
                    <input type="text" id="manualCode" placeholder="Código de barras">
                    <button onclick="addProductByCode()">Agregar</button>
                    
                    <div class="products-quick-list">
                        <h3>Productos Disponibles</h3>
                        <input type="text" id="searchQuickProduct" placeholder="Buscar producto..." onkeyup="filterQuickProducts()">
                        <div id="quickProductList" class="quick-product-items"></div>
                    </div>
                </div>
                
                <div class="cart-area">
                    <h2>Carrito de Compra</h2>
                    <table id="cartTable">
                        <thead>
                            <tr>
                                <th>Producto</th>
                                <th>Precio</th>
                                <th>Cantidad</th>
                                <th>Subtotal</th>
                                <th>Acción</th>
                            </tr>
                        </thead>
                        <tbody id="cartBody"></tbody>
                    </table>
                    <div class="cart-total">
                        <button onclick="showCustomProductModal()" class="btn-custom-product" title="Agregar producto personalizado">
                            <span style="font-size: 20px;">+</span> Producto Personalizado
                        </button>
                        <h3>Total: $<span id="cartTotal">0.00</span></h3>
                        <button onclick="finalizeSale()" class="btn-primary">Finalizar Venta</button>
                        <button onclick="clearCart()" class="btn-secondary">Limpiar</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Sección de Productos -->
        <div id="productosSection" class="section">
            <h2>Gestión de Productos</h2>
            <div class="product-form">
                <h3>Agregar/Editar Producto</h3>
                <form id="productForm">
                    <input type="hidden" id="productId">
                    <input type="text" id="productName" placeholder="Nombre del producto" required>
                    <input type="number" id="productPrice" placeholder="Precio (COP)" step="1" required>
                    <input type="number" id="productStock" placeholder="Stock inicial" required>
                    <input type="text" id="productBarcode" placeholder="Código de barras" required>
                    <button type="button" onclick="scanBarcodeForProduct()">Escanear Código</button>
                    <button type="submit">Guardar Producto</button>
                    <button type="button" onclick="cancelEdit()">Cancelar</button>
                </form>
            </div>

            <div class="product-list">
                <h3>Lista de Productos</h3>
                <input type="text" id="searchProduct" placeholder="Buscar producto..." onkeyup="filterProducts()">
                <table id="productTable">
                    <thead>
                        <tr>
                            <th>Nombre</th>
                            <th>Precio</th>
                            <th>Stock</th>
                            <th>Código</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="productBody"></tbody>
                </table>
            </div>
        </div>

        <!-- Sección de Reportes -->
        <div id="reportesSection" class="section">
            <h2>Reportes de Ventas</h2>
            <div class="report-cards">
                <div class="report-card">
                    <h3>Ventas de Hoy</h3>
                    <p class="amount">$<span id="todaySales">0.00</span></p>
                    <p class="count"><span id="todayCount">0</span> ventas</p>
                </div>
                <div class="report-card">
                    <h3>Ventas de Ayer</h3>
                    <p class="amount">$<span id="yesterdaySales">0.00</span></p>
                    <p class="count"><span id="yesterdayCount">0</span> ventas</p>
                </div>
                <div class="report-card">
                    <h3>Ventas del Mes</h3>
                    <p class="amount">$<span id="monthSales">0.00</span></p>
                    <p class="count"><span id="monthCount">0</span> ventas</p>
                </div>
            </div>
            
            <div class="sales-history">
                <h3>Historial de Ventas</h3>
                <button onclick="loadSalesHistory()">Actualizar</button>
                <table id="salesTable">
                    <thead>
                        <tr>
                            <th>Fecha</th>
                            <th>Hora</th>
                            <th>Total</th>
                            <th>Productos</th>
                            <th>Detalles</th>
                        </tr>
                    </thead>
                    <tbody id="salesBody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Modal para escanear código de producto -->
    <div id="barcodeModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeBarcodeModal()">&times;</span>
            <h2>Escanear Código de Barras</h2>
            <div id="productCameraSelector" style="display:none; margin-bottom: 10px;">
                <label>Seleccionar cámara:</label>
                <select id="productCameraSelect" onchange="changeProductCamera()"></select>
            </div>
            <video id="productVideo" autoplay playsinline></video>
            <button onclick="stopProductScanner()">Cerrar</button>
        </div>
    </div>

    <!-- Modal para detalles de venta -->
    <div id="saleDetailModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeSaleDetailModal()">&times;</span>
            <h2>Detalles de la Venta</h2>
            <div id="saleDetailContent"></div>
        </div>
    </div>

    <!-- Modal para producto personalizado -->
    <div id="customProductModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeCustomProductModal()">&times;</span>
            <h2>Agregar Producto Personalizado</h2>
            <form id="customProductForm" onsubmit="addCustomProduct(event)">
                <div class="form-group">
                    <label for="customProductName">Nombre del producto (opcional):</label>
                    <input type="text" id="customProductName" placeholder="Ej: Producto sin código">
                </div>
                <div class="form-group">
                    <label for="customProductPrice">Precio (COP): *</label>
                    <input type="number" id="customProductPrice" placeholder="Ej: 5000" min="0" step="1" required autofocus>
                </div>
                <div class="form-group">
                    <label for="customProductQuantity">Cantidad:</label>
                    <input type="number" id="customProductQuantity" value="1" min="1" step="1" required>
                </div>
                <div class="modal-buttons">
                    <button type="submit" class="btn-primary">Agregar al Carrito</button>
                    <button type="button" onclick="closeCustomProductModal()" class="btn-secondary">Cancelar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Loading overlay -->
    <div id="loadingOverlay" class="loading-overlay">
        <div class="spinner"></div>
        <p>Cargando...</p>
    </div>

    <!-- Cargar librerías primero -->
    <script src="https://unpkg.com/@zxing/library@0.20.0"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="config.js"></script>
    
    <!-- Cargar app después de las librerías -->
    <script>
        // Verificar que las librerías se cargaron
        window.addEventListener('load', function() {
            console.log('=== VERIFICACIÓN DE LIBRERÍAS ===');
            console.log('ZXing disponible:', typeof ZXing !== 'undefined');
            console.log('Supabase disponible:', typeof supabase !== 'undefined');
            
            if (typeof ZXing === 'undefined') {
                console.error('❌ ZXing NO se cargó');
                console.log('Intentando cargar desde CDN alternativa...');
            } else {
                console.log('✅ ZXing cargado:', ZXing);
            }
        });
    </script>
    <script src="app.js"></script>
</body>
</html>
