<html><head><base href="https://example.com">
<meta name="referrer" content="no-referrer">
<title>Reproductor de Video con HLS</title>
<script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
<script src="https://ssl.p.jwpcdn.com/player/v/8.7.4/jwplayer.js"></script>
<script type="importmap">
{
  "imports": {
    "@supabase/supabase-js": "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"
  }
}
</script>
<script>
const SUPABASE_URL = 'https://sawjrahbnadyeqwuybcq.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNhd2pyYWhibmFkeWVxd3V5YmNxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Mzc4NDAwMDAsImV4cCI6MjA1MzQxNjAwMH0.NgX-qfBtynqjfRJC25L5CFLEGnhqeBx9YczUusd7cqI';
let supabase;
async function initSupabase() {
  await new Promise(resolve => {
    if (window.supabase) {
      resolve();
    } else {
      const script = document.createElement('script');
      script.src = 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js';
      script.onload = resolve;
      document.head.appendChild(script);
    }
  });

  const { createClient } = window.supabase;
  supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
}
async function loginWithSupabase() {
  if (!supabase) {
    await initSupabase();
  }

  const email = document.getElementById('email').value;
  const password = document.getElementById('password').value;
  const errorElement = document.getElementById('loginError');

  try {
    const { data, error } = await supabase.auth.signInWithPassword({
      email,
      password
    });

    if (error) throw error;

    currentUser = data.user.email;
    document.getElementById('loginForm').style.display = 'none';
    document.getElementById('videoContainer').style.display = 'block';
    document.getElementById('playlistContainer').style.display = 'block';
    document.getElementById('logoutButton').style.display = 'block';

    const { data: adminData, error: adminError } = await supabase
      .from('admins')
      .select('*')
      .eq('email', currentUser)
      .single();

    if (adminData) {
      document.getElementById('changePasswordContainer').style.display = 'block';
      document.getElementById('addUrlContainer').style.display = 'grid';
      document.getElementById('userManagementContainer').style.display = 'block';
      document.getElementById('databaseConfigContainer').style.display = 'block';
    }

    initializeVideo();
    updatePlaylist();
  } catch (error) {
    errorElement.textContent = error.message;
    console.error('Login error:', error);
  }
}

function logoutFromSupabase() {
  supabase.auth.signOut();
  logout(); 
}

function logout() {
  logoutFromSupabase(); 
}
</script>
<style>
body {
  margin: 0;
  padding: 20px;
  background: #1a1a1a;
  color: white;
  font-family: Arial, sans-serif;
}

.video-container {
  max-width: 800px;
  margin: 0 auto;
  background: #000;
  border-radius: 8px;
  overflow: hidden;
  box-shadow: 0 4px 6px rgba(0,0,0,0.3);
  display: none;
}

video {
  width: 100%;
  height: auto;
}

.controls {
  padding: 15px;
  background: #333;
  display: flex;
  align-items: center;
  gap: 15px;
}

button {
  background: #4CAF50;
  border: none;
  color: white;
  padding: 8px 16px;
  border-radius: 4px;
  cursor: pointer;
  transition: background 0.3s;
}

button:hover {
  background: #45a049;
}

select {
  padding: 6px;
  border-radius: 4px;
  background: #444;
  color: white;
  border: 1px solid #666;
}

.login-container {
  max-width: 400px;
  margin: 50px auto;
  background: #333;
  padding: 20px;
  border-radius: 8px;
  box-shadow: 0 4px 6px rgba(0,0,0,0.3);
}

.login-container input {
  width: 100%;
  padding: 8px;
  margin: 10px 0;
  border: 1px solid #666;
  border-radius: 4px;
  background: #444;
  color: white;
}

.error-message {
  color: #ff4444;
  margin: 10px 0;
}

.main-content {
  display: flex;
  gap: 20px;
  max-width: 1200px;
  margin: 0 auto;
}

.change-password-container {
  display: none;
  width: 300px;
  background: #333;
  padding: 15px;
  border-radius: 8px;
  height: fit-content;
}

.change-password-container input {
  width: 100%;
  padding: 8px;
  margin: 10px 0;
  border: 1px solid #666;
  border-radius: 4px;
  background: #444;
  color: white;
}

.success-message {
  color: #4CAF50;
  margin: 10px 0;
}

.video-section {
  flex-grow: 1;
}

.playlist-container {
  display: none;
  margin-top: 20px;
  background: #333;
  padding: 15px;
  border-radius: 8px;
}

.playlist-item {
  display: flex;
  align-items: center;
  gap: 10px;
  margin-bottom: 10px;
  padding: 10px;
  background: #444;
  border-radius: 4px;
}

.playlist-item button {
  padding: 4px 8px;
}

.add-url-container {
  margin-bottom: 15px;
  display: grid;
  grid-template-columns: 1fr 1fr auto;
  gap: 10px;
}

.add-url-container input {
  padding: 8px;
  border: 1px solid #666;
  border-radius: 4px;
  background: #444;
  color: white;
}

.playlist-name {
  font-weight: bold;
  margin-right: 10px;
}

.user-management-container {
  width: 300px;
  background: #333;
  padding: 15px;
  border-radius: 8px;
  margin-top: 20px;
  display: none;
}

.user-list {
  margin-top: 15px;
}

.user-item {
  background: #444;
  padding: 10px;
  border-radius: 4px;
  margin-bottom: 10px;
}

.user-form input {
  width: 100%;
  padding: 8px;
  margin: 5px 0;
  border: 1px solid #666;
  border-radius: 4px;
  background: #444;
  color: white;
}

.user-actions {
  display: flex;
  gap: 10px;
  margin-top: 10px;
}

.expiry-date {
  font-size: 0.9em;
  color: #aaa;
  margin!-top: 5px;
}

.logout-button {
  position: fixed;
  top: 20px;
  left: 20px;
  z-index: 100;
  display: none;
}

.stream-status {
  margin-top: 20px;
  background: #333;
  padding: 15px;
  border-radius: 8px;
}

.status-item {
  display: flex;
  align-items: center;
  gap: 10px;
  margin-bottom: 10px;
  padding: 10px;
  background: #444;
  border-radius: 4px;
}

.status-indicator {
  width: 12px;
  height: 12px;
  border-radius: 50%;
}

.status-good {
  background: #4CAF50;
}

.status-slow {
  background: #FFA726;
}

.status-error {
  background: #f44336;
}

.status-details {
  display: flex;
  flex-direction: column;
  gap: 4px;
}

.status-name {
  font-weight: bold;
}

.status-message {
  font-size: 0.9em;
  color: #aaa;
}

.database-config-container {
  width: 300px;
  background: #333;
  padding: 15px;
  border-radius: 8px;
  margin-top: 20px;
  display: none;
}

.database-config-container input {
  width: 100%;
  padding: 8px;
  margin: 5px 0;
  border: 1px solid #666;
  border-radius: 4px;
  background: #444;
  color: white;
}

.database-status {
  margin-top: 10px;
  padding: 8px;
  border-radius: 4px;
}

.database-status.connected {
  background: #4CAF50;
  color: white;
}

.database-status.error {
  background: #f44336;
  color: white;
}
</style>
</head>
<body>
<div id="loginForm" class="login-container">
  <h2>Iniciar Sesi&#xf3;n</h2>
  <div id="loginError" class="error-message"></div>
  <input type="email" id="email" placeholder="Correo Electr&#xf3;nico">
  <input type="password" id="password" placeholder="Contrase&#xf1;a">
  <button onclick="loginWithSupabase()">Ingresar</button>
</div>

<div class="main-content">
  <div class="video-section">
    <div class="video-container" id="videoContainer">
      <video id="video" controls></video>
      <div class="controls">
        <button id="playPause">Play/Pause</button>
        <select id="quality">
          <option value>Calidad Auto</option>
        </select>
        <button id="fullscreen">Pantalla Completa</button>
      </div>
    </div>

    <div id="playlistContainer" class="playlist-container">
      <h3>Lista de Reproductores</h3>
      <div class="add-url-container" id="addUrlContainer">
        <input type="text" id="streamName" placeholder="Nombre del stream">
        <input type="text" id="newUrl" placeholder="URL del video">
        <button onclick="addUrl()">Agregar</button>
      </div>
      <div id="playlistItems"></div>
    </div>
  </div>

  <div class="change-password-container" id="changePasswordContainer">
    <h3>Cambiar Contrase&#xf1;a</h3>
    <div id="passwordChangeError" class="error-message"></div>
    <div id="passwordChangeSuccess" class="success-message"></div>
    <input type="password" id="currentPassword" placeholder="Contrase&#xf1;a Actual">
    <input type="password" id="newPassword" placeholder="Nueva Contrase&#xf1;a">
    <input type="password" id="confirmPassword" placeholder="Confirmar Nueva Contrase&#xf1;a">
    <button onclick="changePassword()">Cambiar Contrase&#xf1;a</button>
  </div>

  <div class="user-management-container" id="userManagementContainer">
    <h3>Gesti&#xf3;n de Usuarios</h3>
    <div id="userManagementError" class="error-message"></div>
    <div id="userManagementSuccess" class="success-message"></div>
    <div class="user-form">
      <input type="text" id="newUsername" placeholder="Nombre de usuario">
      <input type="password" id="newUserPassword" placeholder="Contrase&#xf1;a">
      <input type="date" id="expiryDate" placeholder="Fecha de expiraci&#xf3;n">
      <button onclick="createUser()">Crear Usuario</button>
    </div>
    <div class="user-list" id="userList"></div>
  </div>

  <div class="database-config-container" id="databaseConfigContainer">
    <h3>Configuraci&#xf3;n de Base de Datos</h3>
    <div id="dbConfigError" class="error-message"></div>
    <div id="dbConfigSuccess" class="success-message"></div>
    <input type="text" id="dbHost" placeholder="Host de la base de datos">
    <input type="text" id="dbPort" placeholder="Puerto (predeterminado: 3306)">
    <input type="text" id="dbName" placeholder="Nombre de la base de datos">
    <input type="text" id="dbUser" placeholder="Usuario">
    <input type="password" id="dbPassword" placeholder="Contrase&#xf1;a">
    <button onclick="testConnection()">Probar Conexi&#xf3;n</button>
    <button onclick="saveDbConfig()">Guardar Configuraci&#xf3;n</button>
    <div id="dbStatus" class="database-status"></div>
  </div>
</div>
<button id="logoutButton" class="logout-button" onclick="logoutFromSupabase()">Cerrar Sesi&#xf3;n</button>

<script>
let users = {
  'luis': {
    password: 'luis',
    isAdmin: true
  },
  '1': {
    password: '1',
    isAdmin: false
  }
};
let currentUser = null;
let videoUrls = [{
  name: 'Stream Principal',
  url: 'https://stream.gia.tv/giatv/giatv-Gary2CanalGary2Canal/Gary2CanalGary2Canal/chunks.m3u8'
}, {
  name: 'Win+',
  url: 'https://cos1.lolatid.com/winplus/tracks-v1a1/mono.m3u8?token=d0d499e219061037d25d89a5e03201fa6a1dd738-a6-1737825938-1737825878'
}];
videoUrls.push({
  name: 'ESPN',
  url: 'https://cale.pricesaskeloadsc.com/espn1/tracks-v1a1/mono.m3u8?token=269839fde5dc06a07156029ce04a546b6e49241a-bf-1736650792-1736614792'
}, {
  name: 'ESPN 2',
  url: 'https://dglvz29s.fubohd.com/espn2/tracks-v1a1/mono.m3u8?token=922d4289e5897536ea63e8451e976b26f6b5a614-09-1737687500-1737651500'
}, {
  name: 'ESPN 3',
  url: 'https://yxdlc29tzq.fubohd.com/espn3/tracks-v1a1/mono.m3u8?token=88b0d0f1857750cdd675143cdbe38b70ef7f3546-7c-1737687550-1737651550'
});
videoUrls.push({
  name: 'ESPN 4',
  url: 'https://d2hpc3rszq.fubohd.com/espn4/tracks-v1a1/mono.m3u8?token=7e596cd774ad7a063c15252d13b324b9703856a2-e8-1737687648-1737651648'
}, {
  name: 'ESPN EXTRA',
  url: 'https://am91cm5leq.fubohd.com/espn5/tracks-v1a1/mono.m3u8?token=c5bd09a2d5d0b3c24639d45110346b82bec20bc3-a7-1737687690-1737651690'
}, {
  name: 'ESPN Premium',
  url: 'https://cale.pricesaskeloadsc.com/espn1/tracks-v1a1/mono.m3u8?token=269839fde5dc06a07156029ce04a546b6e49241a-bf-1736650792-1736614792'
}, {
  name: 'Directv',
  url: 'https://jf2.naqsheala.com:999/hls/directsp.m3u8?md5=S1zdNKRTyg_rg94qpoBFeg&expires=1737663023'
});
videoUrls.push({
  name: 'Solo eventos',
  url: 'https://jf2.naqsheala.com:999/hls/directsp.m3u8?md5=_eQWBzjGyConBjOd433B3w&expires=1737660255'
});
let currentHls = null;
let streamStatuses = {};
let deviceSessions = {};
let dbConfig = {
  host: '',
  database: '',
  user: '',
  password: '',
  port: 3306,
  dialect: 'mysql'
};
const streamGuardConfig = {
  enabled: true,
  anonymizeHeaders: true,
  bypassCors: true,
  maskUserAgent: true,
  maskReferrer: true
};
let jwPlayer = null;
function initStreamGuard() {
  if (!streamGuardConfig.enabled) return;
  const originalFetch = window.fetch;
  window.fetch = async function (url, options = {}) {
    options.credentials = 'omit';
    options.headers = {
      ...options.headers,
      'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36',
      'Referer': '',
      'Origin': null
    };
    return originalFetch(url, options);
  };
}
function generateDeviceId() {
  return Math.random().toString(36).substring(2) + Date.now().toString(36);
}
function login() {
  if (streamGuardConfig.enabled) {
    sessionStorage.clear();
    localStorage.removeItem('hlsPlayerData');
    document.cookie = 'hlsPlayerSession=; expires=Thu, 01 Jan 1970 00:00:00 GMT; secure; samesite=strict';
  }
  const username = document.getElementById('username').value;
  const password = document.getElementById('password').value;
  const errorElement = document.getElementById('loginError');
  if (users[username] && users[username].password === password) {
    if (users[username].expiryDate && new Date(users[username].expiryDate) < new Date()) {
      errorElement.textContent = 'Tu cuenta ha expirado';
      return;
    }
    const deviceId = generateDeviceId();
    if (deviceSessions[username]) {
      const oldDeviceId = deviceSessions[username];
      localStorage.setItem('forceLogout', JSON.stringify({
        username: username,
        deviceId: oldDeviceId,
        timestamp: Date.now()
      }));
    }
    deviceSessions[username] = deviceId;
    localStorage.setItem('currentDevice', JSON.stringify({
      username: username,
      deviceId: deviceId
    }));
    currentUser = username;
    document.getElementById('loginForm').style.display = 'none';
    document.getElementById('videoContainer').style.display = 'block';
    document.getElementById('playlistContainer').style.display = 'block';
    if (username === 'luis') {
      document.getElementById('changePasswordContainer').style.display = 'block';
      document.getElementById('addUrlContainer').style.display = 'grid';
      document.getElementById('userManagementContainer').style.display = 'block';
      document.getElementById('databaseConfigContainer').style.display = 'block';
      renderUserCredentialsList();
    } else {
      document.getElementById('addUrlContainer').style.display = 'none';
    }
    document.getElementById('logoutButton').style.display = 'block';
    initializeVideo();
    updatePlaylist();
    if (username === 'n') {
      updateUserList();
    }
  } else {
    errorElement.textContent = 'Usuario o contraseña incorrectos';
  }
}
function changePassword() {
  const currentPassword = document.getElementById('currentPassword').value;
  const newPassword = document.getElementById('newPassword').value;
  const confirmPassword = document.getElementById('confirmPassword').value;
  const errorElement = document.getElementById('passwordChangeError');
  const successElement = document.getElementById('passwordChangeSuccess');
  errorElement.textContent = '';
  successElement.textContent = '';
  if (currentPassword !== users[currentUser].password) {
    errorElement.textContent = 'La contraseña actual es incorrecta';
    return;
  }
  if (newPassword !== confirmPassword) {
    errorElement.textContent = 'Las nuevas contraseñas no coinciden';
    return;
  }
  if (newPassword.length < 1) {
    errorElement.textContent = 'La nueva contraseña no puede estar vacía';
    return;
  }
  users[currentUser].password = newPassword;
  successElement.textContent = 'Contraseña cambiada exitosamente';
  document.getElementById('currentPassword').value = '';
  document.getElementById('newPassword').value = '';
  document.getElementById('confirmPassword').value = '';
}
function addUrl() {
  const newName = document.getElementById('streamName').value.trim();
  const newUrl = document.getElementById('newUrl').value.trim();
  if (newUrl && newName && currentUser === 'luis') {
    if (!canPlayUrl(newUrl)) {
      alert('URL must be an HLS stream (.m3u8 or .mpegurl)');
      return;
    }
    videoUrls.push({
      name: newName,
      url: newUrl
    });
    updatePlaylist();
    syncDataWithDb();
    document.getElementById('newUrl').value = '';
    document.getElementById('streamName').value = '';
  }
}
function removeUrl(index) {
  if (currentUser === 'luis') {
    videoUrls.splice(index, 1);
    syncDataWithDb();
    updatePlaylist();
  }
}
function playUrl(url) {
  if (currentHls) {
    currentHls.destroy();
  }
  if (jwPlayer) {
    jwPlayer.remove();
  }
  const video = document.getElementById('video');
  const qualitySelect = document.getElementById('quality');
  qualitySelect.innerHTML = '<option value="">Calidad Auto</option>';
  if (url.toLowerCase().includes('mpegurl')) {
    try {
      jwPlayer = jwplayer('video');
      jwPlayer.setup({
        file: url,
        width: '100%',
        height: 'auto',
        aspectratio: '16:9',
        stretching: 'uniform',
        primary: 'html5',
        hlshtml: true,
        preload: 'metadata',
        controls: true,
        autostart: false
      });
      return;
    } catch (e) {
      console.log('JW Player failed, falling back to HLS.js');
    }
  }
  if (Hls.isSupported()) {
    const config = {
      enableWorker: true,
      maxBufferLength: 60,
      maxMaxBufferLength: 600,
      maxBufferSize: 600000000,
      maxBufferHole: 0.5,
      highBufferWatchdogPeriod: 2,
      abrEwmaDefaultEstimate: 500000,
      abrBandWidthFactor: 0.95,
      abrBandWidthUpFactor: 0.7,
      abrMaxWithRealBitrate: true,
      maxStarvationDelay: 4,
      maxLoadingDelay: 4,
      lowLatencyMode: false,
      backBufferLength: 90,
      xhrSetup: function (xhr, url) {
        if (streamGuardConfig.enabled) {
          xhr.setRequestHeader('User-Agent', 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36');
          xhr.setRequestHeader('Referer', '');
          xhr.setRequestHeader('Origin', null);
          xhr.setRequestHeader('X-Request-ID', Math.random().toString(36));
          xhr.setRequestHeader('Cookie', '');
          xhr.setRequestHeader('Authorization', '');
        }
      },
      loader: class extends Hls.DefaultConfig.loader {
        constructor(config) {
          super(config);
          const load = this.load.bind(this);
          this.load = function (context, config, callbacks) {
            if (streamGuardConfig.enabled) {
              const url = new URL(context.url);
              url.searchParams.forEach((value, key) => {
                if (key.match(/token|auth|key|sign/i)) {
                  url.searchParams.set(key, btoa(value));
                }
              });
              context.url = url.toString();
            }
            return load(context, config, callbacks);
          };
        }
      },
      urlModifier: function (url) {
        if (url.endsWith('.m3u8') || url.endsWith('.mpegurl')) {
          return url;
        }
        return url;
      }
    };
    currentHls = new Hls(config);
    currentHls.loadSource(url);
    currentHls.attachMedia(video);
    currentHls.on(Hls.Events.ERROR, function (event, data) {
      const streamIndex = videoUrls.findIndex(item => item.url === url);
      if (streamIndex !== -1) {
        streamStatuses[url] = {
          status: 'error',
          message: `Error: ${data.type} - ${data.details}`
        };
        updateStreamStatus();
      }
    });
    currentHls.on(Hls.Events.FRAG_LOADED, function (event, data) {
      const loadTime = data.stats.loading.end - data.stats.loading.start;
      const streamIndex = videoUrls.findIndex(item => item.url === url);
      if (streamIndex !== -1) {
        if (loadTime > 2000) {
          streamStatuses[url] = {
            status: 'slow',
            message: 'Reproducción lenta - Alta latencia'
          };
        } else {
          streamStatuses[url] = {
            status: 'good',
            message: 'Reproducción estable'
          };
        }
        updateStreamStatus();
      }
    });
    currentHls.on(Hls.Events.MANIFEST_PARSED, function (event, data) {
      const qualities = data.levels.map((level, index) => ({
        index: index,
        resolution: `${level.width}x${level.height}`,
        bitrate: level.bitrate
      }));
      qualities.forEach(quality => {
        const option = document.createElement('option');
        option.value = quality.index;
        option.text = `${quality.resolution} (${Math.round(quality.bitrate / 1000)} kbps)`;
        qualitySelect.appendChild(option);
      });
      video.play();
    });
  } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
    video.src = url;
    video.addEventListener('loadedmetadata', function () {
      video.play();
    });
  } else {
    console.error('This browser does not support HLS playback');
  }
}
function updatePlaylist() {
  const container = document.getElementById('playlistItems');
  container.innerHTML = '';
  videoUrls.forEach((item, index) => {
    const playlistItem = document.createElement('div');
    playlistItem.className = 'playlist-item';
    const playButton = document.createElement('button');
    playButton.textContent = 'Reproducir';
    playButton.onclick = () => {
      playUrl(item.url);
    };
    const nameSpan = document.createElement('span');
    nameSpan.className = 'playlist-name';
    nameSpan.textContent = item.name;
    playlistItem.appendChild(playButton);
    playlistItem.appendChild(nameSpan);
    if (currentUser === 'luis') {
      const urlText = document.createElement('span');
      urlText.textContent = item.url;
      playlistItem.appendChild(urlText);
    }
    if (currentUser === 'luis') {
      const removeButton = document.createElement('button');
      removeButton.textContent = 'Eliminar';
      removeButton.onclick = () => removeUrl(index);
      playlistItem.appendChild(removeButton);
    }
    container.appendChild(playlistItem);
  });
  updateStreamStatus();
}
function initializeVideo() {
  const video = document.getElementById('video');
  const playPauseBtn = document.getElementById('playPause');
  const qualitySelect = document.getElementById('quality');
  const fullscreenBtn = document.getElementById('fullscreen');
  playUrl(videoUrls[0].url);
  currentHls.on(Hls.Events.MANIFEST_PARSED, function (event, data) {
    const qualities = [{
      index: 0,
      resolution: '144p',
      height: 144
    }, {
      index: 1,
      resolution: '240p',
      height: 240
    }, {
      index: 2,
      resolution: '360p',
      height: 360
    }, {
      index: 3,
      resolution: '480p',
      height: 480
    }];
    qualitySelect.innerHTML = '<option value="">Calidad Auto</option>';
    data.levels.forEach(level => {
      const matchingQuality = qualities.find(q => Math.abs(level.height - q.height) <= 50);
      if (matchingQuality) {
        const option = document.createElement('option');
        option.value = level.index;
        option.text = matchingQuality.resolution;
        qualitySelect.appendChild(option);
      }
    });
    video.play();
  });
  playPauseBtn.addEventListener('click', function () {
    if (video.paused) {
      video.play();
    } else {
      video.pause();
    }
  });
  fullscreenBtn.addEventListener('click', function () {
    if (!document.fullscreenElement) {
      if (video.requestFullscreen) {
        video.requestFullscreen();
      } else if (video.webkitRequestFullscreen) {
        video.webkitRequestFullscreen();
      } else if (video.msRequestFullscreen) {
        video.msRequestFullscreen();
      }
    } else {
      if (document.exitFullscreen) {
        document.exitFullscreen();
      } else if (document.webkitExitFullscreen) {
        document.webkitExitFullscreen();
      } else if (document.msExitFullscreen) {
        document.msExitFullscreen();
      }
    }
  });
  video.addEventListener('play', () => {
    playPauseBtn.textContent = 'Pause';
  });
  video.addEventListener('pause', () => {
    playPauseBtn.textContent = 'Play';
  });
  qualitySelect.addEventListener('change', function () {
    if (currentHls) {
      if (this.value === '') {
        currentHls.currentLevel = -1;
      } else {
        const selectedLevel = Number(this.value);
        currentHls.currentLevel = selectedLevel;
        console.log(`Selected quality: ${currentHls.levels[selectedLevel].height}p`);
      }
    }
  });
}
function createUser() {
  if (currentUser !== 'luis') return;
  const username = document.getElementById('newUsername').value.trim();
  const password = document.getElementById('newUserPassword').value;
  const expiryDate = document.getElementById('expiryDate').value;
  const errorElement = document.getElementById('userManagementError');
  const successElement = document.getElementById('userManagementSuccess');
  errorElement.textContent = '';
  successElement.textContent = '';
  if (!username || !password) {
    errorElement.textContent = 'Usuario y contraseña son requeridos';
    return;
  }
  if (users[username]) {
    errorElement.textContent = 'El usuario ya existe';
    return;
  }
  users[username] = {
    password: password,
    expiryDate: expiryDate || null
  };
  successElement.textContent = 'Usuario creado exitosamente';
  document.getElementById('newUsername').value = '';
  document.getElementById('newUserPassword').value = '';
  document.getElementById('expiryDate').value = '';
  updateUserList();
  syncDataWithDb();
}
function updateUserList() {
  if (currentUser !== 'luis') {
    const existingList = document.getElementById('userCredentialsList');
    if (existingList) {
      existingList.remove();
    }
    return;
  }
  const container = document.getElementById('userList');
  container.innerHTML = '';
  Object.entries(users).forEach(([username, userData]) => {
    if (username === 'luis') return;
    const userItem = document.createElement('div');
    userItem.className = 'user-item';
    const nameElement = document.createElement('div');
    nameElement.textContent = `Usuario: ${username}`;
    userItem.appendChild(nameElement);
    if (userData.expiryDate) {
      const expiryElement = document.createElement('div');
      expiryElement.className = 'expiry-date';
      expiryElement.textContent = `Expira: ${new Date(userData.expiryDate).toLocaleDateString()}`;
      userItem.appendChild(expiryElement);
    }
    const actions = document.createElement('div');
    actions.className = 'user-actions';
    const editButton = document.createElement('button');
    editButton.textContent = 'Editar';
    editButton.onclick = () => editUser(username);
    const deleteButton = document.createElement('button');
    deleteButton.textContent = 'Eliminar';
    deleteButton.onclick = () => deleteUser(username);
    actions.appendChild(editButton);
    actions.appendChild(deleteButton);
    userItem.appendChild(actions);
    container.appendChild(userItem);
  });
  if (currentUser === 'luis') {
    renderUserCredentialsList();
  }
}
function editUser(username) {
  if (currentUser !== 'luis') return;
  const newPassword = prompt('Nueva contraseña para ' + username);
  const newExpiryDate = prompt('Nueva fecha de expiración (YYYY-MM-DD)');
  if (newPassword !== null) {
    users[username].password = newPassword;
  }
  if (newExpiryDate !== null) {
    users[username].expiryDate = newExpiryDate;
  }
  updateUserList();
  syncDataWithDb();
}
function deleteUser(username) {
  if (currentUser !== 'luis' || username === 'luis') return;
  if (confirm(`¿Estás seguro de eliminar al usuario ${username}?`)) {
    delete users[username];
    updateUserList();
    syncDataWithDb();
  }
}
function logout() {
  if (currentUser) {
    delete deviceSessions[currentUser];
    localStorage.removeItem('currentDevice');
  }
  currentUser = null;
  if (jwPlayer) {
    jwPlayer.remove();
    jwPlayer = null;
  }
  document.getElementById('loginForm').style.display = 'block';
  document.getElementById('videoContainer').style.display = 'none';
  document.getElementById('playlistContainer').style.display = 'none';
  document.getElementById('changePasswordContainer').style.display = 'none';
  document.getElementById('userManagementContainer').style.display = 'none';
  document.getElementById('databaseConfigContainer').style.display = 'none';
  document.getElementById('logoutButton').style.display = 'none';
  document.getElementById('username').value = '';
  document.getElementById('password').value = '';
  document.getElementById('loginError').textContent = '';
  const video = document.getElementById('video');
  video.pause();
  if (currentHls) {
    currentHls.destroy();
    currentHls = null;
  }
  streamStatuses = {};
}
function updateStreamStatus() {
  const container = document.getElementById('playlistContainer');
  let statusContainer = document.querySelector('.stream-status');
  if (!statusContainer) {
    statusContainer = document.createElement('div');
    statusContainer.className = 'stream-status';
    statusContainer.innerHTML = '<h3>Estado de Streams</h3>';
    container.appendChild(statusContainer);
  }
  const statusContent = document.createElement('div');
  videoUrls.forEach(item => {
    const status = streamStatuses[item.url] || {
      status: 'unknown',
      message: 'No reproducido aún'
    };
    const statusItem = document.createElement('div');
    statusItem.className = 'status-item';
    const indicator = document.createElement('div');
    indicator.className = `status-indicator status-${status.status}`;
    const details = document.createElement('div');
    details.className = 'status-details';
    const name = document.createElement('div');
    name.className = 'status-name';
    name.textContent = item.name;
    const message = document.createElement('div');
    message.className = 'status-message';
    message.textContent = status.message;
    details.appendChild(name);
    details.appendChild(message);
    statusItem.appendChild(indicator);
    statusItem.appendChild(details);
    statusContent.appendChild(statusItem);
  });
  statusContainer.innerHTML = '<h3>Estado de Streams</h3>';
  statusContainer.appendChild(statusContent);
}
async function testConnection() {
  const errorElement = document.getElementById('dbConfigError');
  const successElement = document.getElementById('dbConfigSuccess');
  const statusElement = document.getElementById('dbStatus');
  try {
    const response = await fetch('api!//test-mysql-connection', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        host: document.getElementById('dbHost').value,
        database: document.getElementById('dbName').value,
        user: document.getElementById('dbUser').value,
        password: document.getElementById('dbPassword').value,
        port: document.getElementById('dbPort').value || 3306,
        dialect: 'mysql'
      })
    });
    const data = await response.json();
    if (data.success) {
      statusElement.className = 'database-status connected';
      statusElement.textContent = 'Conexión MySQL exitosa';
      errorElement.textContent = '';
      successElement.textContent = 'Prueba de conexión MySQL exitosa';
    } else {
      throw new Error(data.error);
    }
  } catch (error) {
    statusElement.className = 'database-status error';
    statusElement.textContent = 'Error de conexión MySQL';
    errorElement.textContent = `Error: ${error.message}`;
    successElement.textContent = '';
  }
}
async function saveDbConfig() {
  const errorElement = document.getElementById('dbConfigError');
  const successElement = document.getElementById('dbConfigSuccess');
  try {
    const config = {
      host: document.getElementById('dbHost').value,
      database: document.getElementById('dbName').value,
      user: document.getElementById('dbUser').value,
      password: document.getElementById('dbPassword').value,
      port: document.getElementById('dbPort').value || 3306,
      dialect: 'mysql'
    };
    const response = await fetch('api/save-mysql-config', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify(config)
    });
    const data = await response.json();
    if (data.success) {
      dbConfig = config;
      successElement.textContent = 'Configuración MySQL guardada exitosamente';
      errorElement.textContent = '';
      await syncDataWithDb();
    } else {
      throw new Error(data.error);
    }
  } catch (error) {
    errorElement.textContent = `Error: ${error.message}`;
    successElement.textContent = '';
  }
}
async function syncDataWithDb() {
  try {
    const usersResponse = await fetch('api/sync-mysql-users', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        users,
        dbConfig: {
          host: document.getElementById('dbHost').value,
          database: document.getElementById('dbName').value,
          user: document.getElementById('dbUser').value,
          password: document.getElementById('dbPassword').value,
          port: document.getElementById('dbPort').value || 3306
        }
      })
    });
    const urlsResponse = await fetch('api/sync-mysql-urls', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        videoUrls,
        dbConfig: {
          host: document.getElementById('dbHost').value,
          database: document.getElementById('dbName').value,
          user: document.getElementById('dbUser').value,
          password: document.getElementById('dbPassword').value,
          port: document.getElementById('dbPort').value || 3306
        }
      })
    });
    return usersResponse.ok && urlsResponse.ok;
  } catch (error) {
    console.error('Error syncing data with MySQL:', error);
    return false;
  }
}
function renderUserCredentialsList() {
  if (currentUser !== 'luis') return;
  const container = document.getElementById('userManagementContainer');
  let existingList = document.getElementById('userCredentialsList');
  if (existingList) {
    existingList.remove();
  }
  const userCredentialsDiv = document.createElement('div');
  userCredentialsDiv.id = 'userCredentialsList';
  userCredentialsDiv.innerHTML = '<h3>Credenciales de Usuarios</h3>';
  const table = document.createElement('table');
  table.style.width = '100%';
  table.style.borderCollapse = 'collapse';
  const headerRow = table.insertRow();
  ['Usuario', 'Contraseña'].forEach(header => {
    const th = document.createElement('th');
    th.textContent = header;
    th.style.border = '1px solid #444';
    th.style.padding = '8px';
    headerRow.appendChild(th);
  });
  Object.entries(users).filter(([username]) => username.startsWith('dn')).forEach(([username, userData]) => {
    const row = table.insertRow();
    const usernameCell = row.insertCell();
    usernameCell.textContent = username;
    usernameCell.style.border = '1px solid #444';
    usernameCell.style.padding = '8px';
    const passwordCell = row.insertCell();
    passwordCell.textContent = userData.password;
    passwordCell.style.border = '1px solid #444';
    passwordCell.style.padding = '8px';
  });
  userCredentialsDiv.appendChild(table);
  container.appendChild(userCredentialsDiv);
}
function canPlayUrl(url) {
  return url.endsWith('.m3u8') || url.endsWith('.mpegurl') || url.includes('m3u8') || url.toLowerCase().includes('mpegurl') || url.toLowerCase().includes('.mp4') || url.toLowerCase().includes('.m4v');
}
window.addEventListener('storage', e => {
  if (e.key === 'forceLogout') {
    const data = JSON.parse(e.newValue);
    const currentDevice = localStorage.getItem('currentDevice');
    if (currentDevice) {
      const deviceData = JSON.parse(currentDevice);
      if (deviceData.username === data.username && deviceData.deviceId === data.deviceId) {
        logout();
        alert('Se ha iniciado sesión en otro dispositivo');
      }
    }
  }
});
window.addEventListener('load', async () => {
  initStreamGuard();
  await initSupabase(); 
});
</script>
</body>
</html>
